# PHL-Hardening

## Token Spec

```yaml
Name:           PHL-Hardening
Intent:         취약점과 안정성 리스크를 최소화한다
Scope:          사용자가 지정한 모듈/파일/레포 전체
Non-Goals:
  - 기능 추가 (필요 시 PHL-Expansion 사용)
  - 성능 최적화 (보안과 충돌 시 보안 우선)
  - UI/UX 변경
Preconditions:
  - 대상 코드가 존재할 것
  - 현재 동작하는 상태일 것 (깨진 코드에 보안 적용은 무의미)
```

---

## Procedure (단계별 수행)

### Step 1: 위협 표면 분석
- [ ] 외부 입력 지점 식별 (사용자 입력, URL 파라미터, API 요청 본문)
- [ ] 외부 출력 지점 식별 (HTML 렌더링, API 응답, 로그)
- [ ] 인증/인가 경계 식별
- [ ] 민감 데이터 흐름 추적 (비밀키, 토큰, 개인정보)
- [ ] 제3자 의존성 목록 확인

### Step 2: 입력 검증
- [ ] 모든 외부 입력에 타입 검증
- [ ] 문자열 입력: 길이 제한, 허용 문자 화이트리스트
- [ ] 숫자 입력: 범위 검증 (min/max)
- [ ] 파일 입력: 확장자/MIME/크기 검증
- [ ] SQL/NoSQL: 파라미터 바인딩 (문자열 연결 금지)
- [ ] HTML 출력: 이스케이프 처리 (XSS 방지)

### Step 3: 인증/인가
- [ ] 인증 우회 가능 경로 점검
- [ ] 권한 체크가 모든 보호 경로에 존재하는지 확인
- [ ] 세션/토큰 만료 정책 확인
- [ ] CORS 설정 점검 (해당 시)

### Step 4: 비밀키/민감정보 처리
- [ ] 하드코딩된 비밀키/토큰/비밀번호 검출
- [ ] 환경변수 또는 시크릿 매니저로 이동
- [ ] `.gitignore`에 민감 파일 포함 확인
- [ ] 로그에 민감정보 노출 여부 확인

### Step 5: 안정성 강화
- [ ] Rate limiting 존재 여부 (API 엔드포인트)
- [ ] 타임아웃 설정 (외부 호출, DB 쿼리)
- [ ] 리소스 해제 확인 (파일 핸들, DB 커넥션)
- [ ] 안전한 기본값 (fail-closed, deny by default)

### Step 6: 의존성 점검
- [ ] 알려진 취약점 있는 패키지 확인
- [ ] 불필요한 의존성 제거
- [ ] 버전 고정 (lockfile 존재 확인)

---

## Validation (성공 판정)

- [ ] 보안 체크리스트 전항목 통과
- [ ] 기존 테스트 통과 (regression 없음)
- [ ] 하드코딩된 비밀키 0건
- [ ] 미검증 외부 입력 0건

---

## Artifacts (산출물)

| 유형 | 설명 |
|------|------|
| 수정된 모듈 | 입력 검증 + 인증 + 비밀키 처리 |
| 보안 리포트 | 발견된 이슈 + 수정 내용 요약 |
| .gitignore | 민감 파일 추가 (필요 시) |

---

## Commit Policy

```
PHL-Hardening: <module> - <summary>

- 입력 검증: [변경 내용]
- 인증/인가: [변경 내용]
- 비밀키 처리: [변경 내용]
- 안정성: [변경 내용]

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>
```

---

## Rollback Policy

- 보안 패치로 기능이 깨진 경우: 기능 복구 우선, 보안은 대안 방법으로 재적용
- 의존성 업데이트로 빌드 실패: 이전 버전으로 복구, 사용자에게 보고
- 보안과 기능 충돌: **보안 우선**, 기능 수정은 별도 커밋

---

## Questions Policy

다음 상황에서 반드시 질문:
- "인증 방식은 무엇입니까?" (JWT/세션/OAuth 등)
- "민감정보 저장 방식은?" (환경변수/시크릿 매니저/vault)
- "Rate limit 기준은?" (초당/분당/IP별/사용자별)
- "보안 강화로 기존 기능이 제한될 수 있습니다. 진행합니까?"
