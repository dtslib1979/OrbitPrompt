# PHL-Reverse

## Token Spec

```yaml
Name:           PHL-Reverse
Intent:         기존 로직을 역방향 관점에서 검증한다
Scope:          사용자가 지정한 모듈/데이터 흐름/파이프라인
Non-Goals:
  - 새 기능 구현
  - 성능 최적화
  - 정방향 로직 수정 (역검증 결과 불일치 발견 시에만)
Preconditions:
  - 정방향 로직이 존재하고 동작할 것
  - 입력/출력 쌍이 명확할 것
```

---

## Procedure (단계별 수행)

### Step 1: 정방향 흐름 매핑
- [ ] 데이터 입력 지점 식별
- [ ] 변환/처리 단계 순서 기록
- [ ] 최종 출력 지점 식별
- [ ] 각 단계의 입력 → 출력 관계 문서화

### Step 2: 역방향 흐름 설계
- [ ] 출력에서 입력으로의 역추적 경로 설계
- [ ] 각 변환 단계의 역함수(inverse) 존재 여부 확인
- [ ] 역함수가 없는 단계: 비가역 지점으로 표시, 검증 가능 범위 명시
- [ ] 역방향 흐름도 작성

### Step 3: 역순 로깅 삽입
- [ ] 각 변환 단계에 입력/출력 쌍 로깅
- [ ] 로그 포맷: `[REVERSE] step={name} input={hash} output={hash} reversible={bool}`
- [ ] 비가역 지점에 경고 로그
- [ ] 로그로 정방향/역방향 일관성 검증 가능하게

### Step 4: 역테스트 작성
- [ ] **정역 일관성 테스트**: `reverse(forward(x)) == x` 검증
- [ ] **불변량 테스트**: 변환 전후 유지되어야 할 속성 검증
- [ ] **경계값 역테스트**: 빈 입력, 최대값, 특수문자에 대한 역변환
- [ ] **비가역 지점 테스트**: 정보 손실이 예상대로인지 확인

### Step 5: 불일치 분석
- [ ] 정방향/역방향 결과 불일치 지점 목록화
- [ ] 각 불일치의 원인 분류:
  - **의도적 비가역** (해싱, 압축 등) → 문서화
  - **버그** → 수정 대상으로 보고
  - **부동소수점/반올림** → 허용 오차 설정
- [ ] 불일치 리포트 생성

---

## Validation (성공 판정)

- [ ] 정역 일관성 테스트 통과 (가역 구간)
- [ ] 불변량 테스트 통과
- [ ] 비가역 지점이 문서화됨
- [ ] 기존 정방향 테스트 regression 없음

---

## Artifacts (산출물)

| 유형 | 설명 |
|------|------|
| 역방향 흐름도 | 데이터 흐름 역추적 문서 |
| 역테스트 파일 | 정역 일관성 + 불변량 + 경계값 |
| 역순 로깅 코드 | 각 변환 단계 입출력 로그 |
| 불일치 리포트 | 발견된 불일치 + 원인 분류 |

---

## Commit Policy

```
PHL-Reverse: <module> - <summary>

- 역방향 매핑: [흐름도/문서]
- 역테스트: [추가된 테스트]
- 역순 로깅: [삽입 지점]
- 불일치: [발견 건수, 의도적/버그 분류]

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>
```

---

## Rollback Policy

- 역순 로깅이 성능에 영향 시: 로깅을 `DEBUG` 레벨로 격하, 프로덕션에서 비활성화
- 역테스트가 정방향 로직을 깨뜨린 경우: 역테스트만 제거, 정방향 보호
- 불일치가 버그인 경우: 별도 `PHL-Expansion` 또는 `fix:` 커밋으로 수정

---

## Questions Policy

다음 상황에서 반드시 질문:
- "어느 데이터 흐름을 역추적합니까?" (범위 미지정 시)
- "비가역 변환이 있습니다. 정보 손실을 허용합니까?"
- "역테스트 허용 오차(tolerance)는?" (부동소수점 연산 시)
- "역순 로깅을 프로덕션에도 남깁니까, DEBUG만?"
