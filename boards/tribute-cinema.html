<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#000000">
  <title>Tribute Cinema</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,400;1,500&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --black: #000000;
      --void: #050505;
      --dark: #0a0a0a;
      --surface: #111111;
      --elevated: #1a1a1a;
      --border: rgba(255,255,255,0.08);
      --white: #f5f5f0;
      --cream: #e8e4dc;
      --muted: rgba(255,255,255,0.5);
      --dim: rgba(255,255,255,0.25);
      --gold: #c9a962;
      --gold-dim: rgba(201,169,98,0.3);
      --serif: 'Cormorant Garamond', Georgia, serif;
      --sans: 'Inter', -apple-system, sans-serif;
    }

    *, *::before, *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: var(--black);
      color: var(--white);
    }

    /* ===== SETUP MODE ===== */
    .setup-mode {
      width: 100%;
      min-height: 100vh;
      background: var(--void);
      padding: 1rem;
      overflow-y: auto;
    }

    .setup-container {
      max-width: 600px;
      margin: 0 auto;
    }

    .setup-header {
      text-align: center;
      padding: 2rem 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 1.5rem;
    }

    .setup-header h1 {
      font-family: var(--serif);
      font-size: 1.75rem;
      font-weight: 400;
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
    }

    .setup-header p {
      font-family: var(--sans);
      font-size: 0.75rem;
      color: var(--muted);
    }

    .setup-section {
      background: var(--surface);
      border: 1px solid var(--border);
      margin-bottom: 1rem;
      overflow: hidden;
    }

    .setup-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.875rem 1rem;
      background: var(--elevated);
      cursor: pointer;
      user-select: none;
    }

    .setup-section-title {
      font-family: var(--sans);
      font-size: 0.6875rem;
      font-weight: 500;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--gold);
    }

    .setup-section-toggle {
      font-size: 0.75rem;
      color: var(--dim);
      transition: transform 0.2s;
    }

    .setup-section.collapsed .setup-section-toggle {
      transform: rotate(-90deg);
    }

    .setup-section.collapsed .setup-section-body {
      display: none;
    }

    .setup-section-body {
      padding: 1rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      display: block;
      font-family: var(--sans);
      font-size: 0.6875rem;
      font-weight: 500;
      color: var(--muted);
      margin-bottom: 0.375rem;
      letter-spacing: 0.05em;
    }

    .form-input {
      width: 100%;
      padding: 0.625rem 0.75rem;
      background: var(--dark);
      border: 1px solid var(--border);
      color: var(--white);
      font-family: var(--sans);
      font-size: 0.8125rem;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--gold);
    }

    .form-input::placeholder {
      color: var(--dim);
    }

    textarea.form-input {
      min-height: 80px;
      resize: vertical;
      line-height: 1.6;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }

    .form-hint {
      font-size: 0.625rem;
      color: var(--dim);
      margin-top: 0.25rem;
    }

    /* Image List */
    .image-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .image-item {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .image-item input {
      flex: 1;
    }

    .image-item button {
      padding: 0.5rem;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
      cursor: pointer;
      font-size: 0.75rem;
    }

    .image-item button:hover {
      border-color: #c44;
      color: #c44;
    }

    .add-image-btn {
      width: 100%;
      padding: 0.5rem;
      background: transparent;
      border: 1px dashed var(--border);
      color: var(--muted);
      font-family: var(--sans);
      font-size: 0.6875rem;
      cursor: pointer;
      margin-top: 0.5rem;
    }

    .add-image-btn:hover {
      border-color: var(--gold);
      color: var(--gold);
    }

    /* Buttons */
    .setup-actions {
      display: flex;
      gap: 0.75rem;
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border);
    }

    .btn {
      flex: 1;
      padding: 0.875rem 1rem;
      font-family: var(--sans);
      font-size: 0.6875rem;
      font-weight: 500;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-secondary {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--muted);
    }

    .btn-secondary:hover {
      border-color: var(--gold);
      color: var(--gold);
    }

    .btn-primary {
      background: var(--gold);
      color: var(--black);
    }

    .btn-primary:hover {
      filter: brightness(1.1);
    }

    /* Duration Settings */
    .duration-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
    }

    .duration-option {
      padding: 0.625rem;
      background: var(--dark);
      border: 1px solid var(--border);
      color: var(--muted);
      font-family: var(--sans);
      font-size: 0.6875rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.15s;
    }

    .duration-option:hover,
    .duration-option.active {
      border-color: var(--gold);
      color: var(--gold);
    }

    /* ===== BROADCAST MODE ===== */
    .broadcast-mode {
      display: none;
      width: 100%;
      height: 100%;
      background: var(--black);
      position: relative;
      overflow: hidden;
    }

    .broadcast-mode.active {
      display: block;
    }

    /* Film Grain */
    .grain-overlay {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 100;
      opacity: 0.04;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.7' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
    }

    /* Vignette */
    .vignette-overlay {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 99;
      background: radial-gradient(ellipse at center, transparent 0%, transparent 50%, rgba(0,0,0,0.7) 100%);
    }

    /* Slide */
    .slide {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 1.5s ease, visibility 1.5s ease;
    }

    .slide.active {
      opacity: 1;
      visibility: visible;
    }

    .slide.exiting {
      opacity: 0;
    }

    /* Slide Background */
    .slide-bg {
      position: absolute;
      inset: 0;
      overflow: hidden;
    }

    .slide-bg-image {
      position: absolute;
      inset: -10%;
      width: 120%;
      height: 120%;
      object-fit: cover;
      filter: brightness(0.6) contrast(1.1);
    }

    /* Ken Burns Animations */
    @keyframes kb-zoom-in {
      from { transform: scale(1); }
      to { transform: scale(1.15); }
    }

    @keyframes kb-zoom-out {
      from { transform: scale(1.15); }
      to { transform: scale(1); }
    }

    @keyframes kb-pan-left {
      from { transform: translateX(5%) scale(1.08); }
      to { transform: translateX(-5%) scale(1.08); }
    }

    @keyframes kb-pan-right {
      from { transform: translateX(-5%) scale(1.08); }
      to { transform: translateX(5%) scale(1.08); }
    }

    @keyframes kb-pan-up {
      from { transform: translateY(5%) scale(1.08); }
      to { transform: translateY(-5%) scale(1.08); }
    }

    .kb-zoom-in .slide-bg-image { animation: kb-zoom-in var(--kb-duration, 20s) ease-out forwards; }
    .kb-zoom-out .slide-bg-image { animation: kb-zoom-out var(--kb-duration, 20s) ease-out forwards; }
    .kb-pan-left .slide-bg-image { animation: kb-pan-left var(--kb-duration, 20s) ease-in-out forwards; }
    .kb-pan-right .slide-bg-image { animation: kb-pan-right var(--kb-duration, 20s) ease-in-out forwards; }
    .kb-pan-up .slide-bg-image { animation: kb-pan-up var(--kb-duration, 20s) ease-in-out forwards; }

    /* Slide Content */
    .slide-content {
      position: relative;
      z-index: 10;
      text-align: center;
      max-width: 85%;
      padding: 2rem;
    }

    /* Title Slide */
    .slide-title-main {
      font-family: var(--serif);
      font-size: clamp(2.5rem, 8vw, 5rem);
      font-weight: 300;
      letter-spacing: 0.1em;
      line-height: 1.1;
      margin-bottom: 1rem;
      text-shadow: 0 4px 30px rgba(0,0,0,0.8);
    }

    .slide-title-sub {
      font-family: var(--serif);
      font-size: clamp(1rem, 3vw, 1.5rem);
      font-weight: 400;
      font-style: italic;
      color: var(--cream);
      letter-spacing: 0.15em;
      text-shadow: 0 2px 20px rgba(0,0,0,0.8);
    }

    .slide-years {
      font-family: var(--sans);
      font-size: clamp(0.875rem, 2vw, 1.125rem);
      font-weight: 300;
      letter-spacing: 0.3em;
      color: var(--gold);
      margin-top: 2rem;
      text-shadow: 0 2px 20px rgba(0,0,0,0.8);
    }

    /* Content Slide */
    .slide-chapter {
      font-family: var(--sans);
      font-size: 0.625rem;
      font-weight: 500;
      letter-spacing: 0.3em;
      text-transform: uppercase;
      color: var(--gold);
      margin-bottom: 1.5rem;
      text-shadow: 0 2px 10px rgba(0,0,0,0.8);
    }

    .slide-heading {
      font-family: var(--serif);
      font-size: clamp(1.75rem, 5vw, 3rem);
      font-weight: 400;
      letter-spacing: 0.05em;
      line-height: 1.3;
      margin-bottom: 1.5rem;
      text-shadow: 0 4px 30px rgba(0,0,0,0.8);
    }

    .slide-quote {
      font-family: var(--serif);
      font-size: clamp(1.125rem, 3vw, 1.75rem);
      font-weight: 400;
      font-style: italic;
      line-height: 1.6;
      color: var(--cream);
      max-width: 800px;
      margin: 0 auto;
      text-shadow: 0 2px 20px rgba(0,0,0,0.8);
    }

    .slide-quote::before {
      content: '"';
      font-size: 150%;
      color: var(--gold);
      opacity: 0.6;
    }

    .slide-quote::after {
      content: '"';
      font-size: 150%;
      color: var(--gold);
      opacity: 0.6;
    }

    .slide-attribution {
      font-family: var(--sans);
      font-size: 0.75rem;
      font-weight: 400;
      letter-spacing: 0.1em;
      color: var(--muted);
      margin-top: 1.5rem;
      text-shadow: 0 2px 10px rgba(0,0,0,0.8);
    }

    /* Carousel within slide */
    .slide-carousel {
      position: absolute;
      inset: 0;
    }

    .carousel-image {
      position: absolute;
      inset: -10%;
      width: 120%;
      height: 120%;
      object-fit: cover;
      opacity: 0;
      transition: opacity 1.5s ease;
      filter: brightness(0.6) contrast(1.1);
    }

    .carousel-image.active {
      opacity: 1;
    }

    /* Progress Bar */
    .progress-container {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: rgba(255,255,255,0.1);
      z-index: 50;
    }

    .progress-bar {
      height: 100%;
      background: var(--gold);
      width: 0%;
      transition: width 0.3s linear;
    }

    /* Timeline */
    .timeline {
      position: fixed;
      right: 1.5rem;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      z-index: 50;
    }

    .timeline-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      cursor: pointer;
      transition: all 0.3s;
    }

    .timeline-dot:hover {
      background: rgba(255,255,255,0.4);
    }

    .timeline-dot.active {
      background: var(--gold);
      border-color: var(--gold);
      box-shadow: 0 0 10px var(--gold-dim);
    }

    /* Controls */
    .controls {
      position: fixed;
      top: 1rem;
      left: 1rem;
      right: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 50;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .broadcast-mode:hover .controls {
      opacity: 1;
    }

    .control-btn {
      padding: 0.5rem 0.75rem;
      background: rgba(0,0,0,0.6);
      border: 1px solid rgba(255,255,255,0.2);
      color: var(--white);
      font-family: var(--sans);
      font-size: 0.625rem;
      letter-spacing: 0.1em;
      cursor: pointer;
      backdrop-filter: blur(10px);
      transition: all 0.2s;
    }

    .control-btn:hover {
      border-color: var(--gold);
      color: var(--gold);
    }

    .timer {
      font-family: var(--sans);
      font-size: 0.75rem;
      font-weight: 500;
      letter-spacing: 0.1em;
      color: var(--white);
      background: rgba(0,0,0,0.6);
      padding: 0.5rem 1rem;
      backdrop-filter: blur(10px);
    }

    /* Ending Slide */
    .ending-content {
      text-align: center;
    }

    .ending-line {
      width: 60px;
      height: 1px;
      background: var(--gold);
      margin: 0 auto 2rem;
    }

    .ending-text {
      font-family: var(--serif);
      font-size: clamp(1.5rem, 4vw, 2.5rem);
      font-weight: 300;
      font-style: italic;
      color: var(--cream);
      letter-spacing: 0.1em;
    }

    .ending-name {
      font-family: var(--serif);
      font-size: clamp(2rem, 6vw, 4rem);
      font-weight: 400;
      letter-spacing: 0.15em;
      margin: 2rem 0;
    }

    .ending-years {
      font-family: var(--sans);
      font-size: 1rem;
      font-weight: 300;
      letter-spacing: 0.4em;
      color: var(--gold);
    }

    /* Responsive */
    @media (max-width: 640px) {
      .timeline { display: none; }
      .slide-content { max-width: 95%; padding: 1rem; }
    }

    /* Hidden */
    .hidden { display: none !important; }
  </style>
</head>
<body>

  <!-- SETUP MODE -->
  <div class="setup-mode" id="setupMode">
    <div class="setup-container">
      <header class="setup-header">
        <h1>Tribute Cinema</h1>
        <p>18분 러닝타임 시네마틱 추모 영상</p>
      </header>

      <!-- Subject Info -->
      <div class="setup-section" id="sectionSubject">
        <div class="setup-section-header" onclick="toggleSection('sectionSubject')">
          <span class="setup-section-title">인물 정보</span>
          <span class="setup-section-toggle">▼</span>
        </div>
        <div class="setup-section-body">
          <div class="form-group">
            <label class="form-label">이름</label>
            <input type="text" class="form-input" id="subjectName" placeholder="홍길동">
          </div>
          <div class="form-group">
            <label class="form-label">부제 / 직함</label>
            <input type="text" class="form-input" id="subjectTitle" placeholder="시대를 앞서간 선구자">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">출생</label>
              <input type="text" class="form-input" id="birthYear" placeholder="1950">
            </div>
            <div class="form-group">
              <label class="form-label">사망</label>
              <input type="text" class="form-input" id="deathYear" placeholder="2024">
            </div>
          </div>
        </div>
      </div>

      <!-- Duration Settings -->
      <div class="setup-section" id="sectionDuration">
        <div class="setup-section-header" onclick="toggleSection('sectionDuration')">
          <span class="setup-section-title">재생 설정</span>
          <span class="setup-section-toggle">▼</span>
        </div>
        <div class="setup-section-body">
          <div class="form-group">
            <label class="form-label">섹션당 시간</label>
            <div class="duration-grid">
              <div class="duration-option" data-duration="60">1분</div>
              <div class="duration-option active" data-duration="120">2분</div>
              <div class="duration-option" data-duration="180">3분</div>
            </div>
            <p class="form-hint">9개 섹션 × 2분 = 18분 총 러닝타임</p>
          </div>
          <div class="form-group">
            <label class="form-label">자동 재생</label>
            <div class="duration-grid">
              <div class="duration-option" data-auto="off">수동</div>
              <div class="duration-option active" data-auto="on">자동</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Sections -->
      <div id="sectionsContainer"></div>

      <!-- Actions -->
      <div class="setup-actions">
        <button class="btn btn-secondary" onclick="loadSample()">샘플 데이터</button>
        <button class="btn btn-secondary" onclick="saveData()">저장</button>
        <button class="btn btn-primary" onclick="startBroadcast()">방송 시작</button>
      </div>
    </div>
  </div>

  <!-- BROADCAST MODE -->
  <div class="broadcast-mode" id="broadcastMode">
    <div class="grain-overlay"></div>
    <div class="vignette-overlay"></div>

    <div class="controls">
      <button class="control-btn" onclick="exitBroadcast()">EXIT</button>
      <div class="timer" id="timer">00:00</div>
      <button class="control-btn" onclick="toggleAutoPlay()">
        <span id="autoPlayLabel">AUTO</span>
      </button>
    </div>

    <div class="timeline" id="timeline"></div>

    <div id="slidesContainer"></div>

    <div class="progress-container">
      <div class="progress-bar" id="progressBar"></div>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const SECTION_TEMPLATES = [
      { id: 'opening', chapter: 'OPENING', title: '오프닝', defaultHeading: '', type: 'title' },
      { id: 'early', chapter: 'CHAPTER I', title: '유년 시절', defaultHeading: '시작의 기억' },
      { id: 'growth', chapter: 'CHAPTER II', title: '성장', defaultHeading: '꿈을 향한 여정' },
      { id: 'peak', chapter: 'CHAPTER III', title: '전성기', defaultHeading: '빛나는 순간들' },
      { id: 'legacy', chapter: 'CHAPTER IV', title: '업적', defaultHeading: '남긴 발자취' },
      { id: 'personal', chapter: 'CHAPTER V', title: '일상', defaultHeading: '가까이에서 본 모습' },
      { id: 'tributes', chapter: 'CHAPTER VI', title: '추억', defaultHeading: '그를 기억하는 사람들' },
      { id: 'final', chapter: 'CHAPTER VII', title: '마지막', defaultHeading: '영원한 안식' },
      { id: 'ending', chapter: 'IN MEMORY', title: '엔딩', defaultHeading: '', type: 'ending' }
    ];

    const KB_EFFECTS = ['kb-zoom-in', 'kb-zoom-out', 'kb-pan-left', 'kb-pan-right', 'kb-pan-up'];

    let state = {
      subject: { name: '', title: '', birth: '', death: '' },
      sections: [],
      duration: 120,
      autoPlay: true,
      currentSlide: 0,
      isPlaying: false,
      timer: 0,
      timerInterval: null,
      carouselIntervals: []
    };

    // ===== INIT =====
    function init() {
      // Generate section forms
      const container = document.getElementById('sectionsContainer');
      SECTION_TEMPLATES.forEach((tpl, idx) => {
        container.innerHTML += generateSectionForm(tpl, idx);
        state.sections.push({
          id: tpl.id,
          chapter: tpl.chapter,
          heading: tpl.defaultHeading,
          quote: '',
          attribution: '',
          images: [''],
          type: tpl.type || 'content'
        });
      });

      // Duration buttons
      document.querySelectorAll('[data-duration]').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('[data-duration]').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          state.duration = parseInt(btn.dataset.duration);
        });
      });

      // Auto play buttons
      document.querySelectorAll('[data-auto]').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('[data-auto]').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          state.autoPlay = btn.dataset.auto === 'on';
        });
      });

      // Load saved data
      const saved = localStorage.getItem('tribute-cinema-data');
      if (saved) {
        try {
          const data = JSON.parse(saved);
          loadData(data);
        } catch(e) {}
      }

      // Keyboard navigation
      document.addEventListener('keydown', handleKeyboard);
    }

    function generateSectionForm(tpl, idx) {
      if (tpl.type === 'title' || tpl.type === 'ending') {
        return `
          <div class="setup-section" id="section${idx}">
            <div class="setup-section-header" onclick="toggleSection('section${idx}')">
              <span class="setup-section-title">${tpl.chapter} — ${tpl.title}</span>
              <span class="setup-section-toggle">▼</span>
            </div>
            <div class="setup-section-body">
              <div class="form-group">
                <label class="form-label">대표 이미지 URL</label>
                <div class="image-list" id="images${idx}">
                  <div class="image-item">
                    <input type="text" class="form-input" placeholder="https://..." onchange="updateImage(${idx}, 0, this.value)">
                    <button onclick="removeImage(${idx}, 0)">✕</button>
                  </div>
                </div>
                <button class="add-image-btn" onclick="addImage(${idx})">+ 이미지 추가</button>
              </div>
            </div>
          </div>
        `;
      }

      return `
        <div class="setup-section collapsed" id="section${idx}">
          <div class="setup-section-header" onclick="toggleSection('section${idx}')">
            <span class="setup-section-title">${tpl.chapter} — ${tpl.title}</span>
            <span class="setup-section-toggle">▼</span>
          </div>
          <div class="setup-section-body">
            <div class="form-group">
              <label class="form-label">섹션 제목</label>
              <input type="text" class="form-input" id="heading${idx}" placeholder="${tpl.defaultHeading}" onchange="updateSection(${idx}, 'heading', this.value)">
            </div>
            <div class="form-group">
              <label class="form-label">인용문 / 내레이션</label>
              <textarea class="form-input" id="quote${idx}" placeholder="이 시기를 대표하는 말이나 기억..." onchange="updateSection(${idx}, 'quote', this.value)"></textarea>
            </div>
            <div class="form-group">
              <label class="form-label">출처 (선택)</label>
              <input type="text" class="form-input" id="attribution${idx}" placeholder="— 누구의 말" onchange="updateSection(${idx}, 'attribution', this.value)">
            </div>
            <div class="form-group">
              <label class="form-label">이미지 URL (여러 장 = 캐러셀)</label>
              <div class="image-list" id="images${idx}">
                <div class="image-item">
                  <input type="text" class="form-input" placeholder="https://..." onchange="updateImage(${idx}, 0, this.value)">
                  <button onclick="removeImage(${idx}, 0)">✕</button>
                </div>
              </div>
              <button class="add-image-btn" onclick="addImage(${idx})">+ 이미지 추가</button>
            </div>
          </div>
        </div>
      `;
    }

    function toggleSection(id) {
      document.getElementById(id).classList.toggle('collapsed');
    }

    function updateSection(idx, field, value) {
      state.sections[idx][field] = value;
    }

    function updateImage(idx, imgIdx, value) {
      state.sections[idx].images[imgIdx] = value;
    }

    function addImage(idx) {
      state.sections[idx].images.push('');
      const list = document.getElementById(`images${idx}`);
      const imgIdx = state.sections[idx].images.length - 1;
      const item = document.createElement('div');
      item.className = 'image-item';
      item.innerHTML = `
        <input type="text" class="form-input" placeholder="https://..." onchange="updateImage(${idx}, ${imgIdx}, this.value)">
        <button onclick="removeImage(${idx}, ${imgIdx})">✕</button>
      `;
      list.appendChild(item);
    }

    function removeImage(idx, imgIdx) {
      if (state.sections[idx].images.length > 1) {
        state.sections[idx].images.splice(imgIdx, 1);
        renderImageList(idx);
      }
    }

    function renderImageList(idx) {
      const list = document.getElementById(`images${idx}`);
      list.innerHTML = state.sections[idx].images.map((img, i) => `
        <div class="image-item">
          <input type="text" class="form-input" value="${img}" placeholder="https://..." onchange="updateImage(${idx}, ${i}, this.value)">
          <button onclick="removeImage(${idx}, ${i})">✕</button>
        </div>
      `).join('');
    }

    // ===== DATA =====
    function saveData() {
      // Collect form data
      state.subject.name = document.getElementById('subjectName').value;
      state.subject.title = document.getElementById('subjectTitle').value;
      state.subject.birth = document.getElementById('birthYear').value;
      state.subject.death = document.getElementById('deathYear').value;

      localStorage.setItem('tribute-cinema-data', JSON.stringify(state));
      alert('저장되었습니다.');
    }

    function loadData(data) {
      state = { ...state, ...data };

      document.getElementById('subjectName').value = state.subject.name || '';
      document.getElementById('subjectTitle').value = state.subject.title || '';
      document.getElementById('birthYear').value = state.subject.birth || '';
      document.getElementById('deathYear').value = state.subject.death || '';

      state.sections.forEach((sec, idx) => {
        const headingEl = document.getElementById(`heading${idx}`);
        const quoteEl = document.getElementById(`quote${idx}`);
        const attrEl = document.getElementById(`attribution${idx}`);
        if (headingEl) headingEl.value = sec.heading || '';
        if (quoteEl) quoteEl.value = sec.quote || '';
        if (attrEl) attrEl.value = sec.attribution || '';
        renderImageList(idx);
      });
    }

    function loadSample() {
      const sample = {
        subject: {
          name: '김철수',
          title: '한국 현대사의 거인',
          birth: '1945',
          death: '2024'
        },
        sections: [
          { id: 'opening', chapter: 'OPENING', heading: '', quote: '', attribution: '', images: ['https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=1600'], type: 'title' },
          { id: 'early', chapter: 'CHAPTER I', heading: '시골 마을의 아이', quote: '어린 시절의 기억은 언제나 따뜻한 햇살과 함께한다. 가난했지만 행복했던 그 시절, 나는 꿈을 꾸기 시작했다.', attribution: '— 1960년 일기에서', images: ['https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=1600', 'https://images.unsplash.com/photo-1469474968028-56623f02e42e?w=1600'] },
          { id: 'growth', chapter: 'CHAPTER II', heading: '배움의 길', quote: '지식은 힘이다. 그러나 그 힘은 나눌 때 비로소 의미를 갖는다.', attribution: '— 1975년 졸업식 연설', images: ['https://images.unsplash.com/photo-1523050854058-8df90110c9f1?w=1600'] },
          { id: 'peak', chapter: 'CHAPTER III', heading: '정상에 서다', quote: '성공이란 결코 혼자 이루는 것이 아니다. 나를 믿어준 모든 분들께 이 영광을 돌린다.', attribution: '— 1990년 수상 소감', images: ['https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?w=1600'] },
          { id: 'legacy', chapter: 'CHAPTER IV', heading: '남긴 것들', quote: '내가 떠난 후에도 이 일이 계속되기를. 그것이 내가 바라는 전부다.', attribution: '— 2020년 인터뷰', images: ['https://images.unsplash.com/photo-1454165804606-c3d57bc86b40?w=1600'] },
          { id: 'personal', chapter: 'CHAPTER V', heading: '아버지, 남편, 친구', quote: '그는 항상 가족을 먼저 생각했습니다. 바쁜 와중에도 우리와의 시간을 소중히 여겼죠.', attribution: '— 가족의 회고', images: ['https://images.unsplash.com/photo-1511895426328-dc8714191300?w=1600'] },
          { id: 'tributes', chapter: 'CHAPTER VI', heading: '그를 기억하며', quote: '그와 함께한 시간은 제 인생의 가장 큰 선물이었습니다. 그의 지혜와 따뜻함을 영원히 기억하겠습니다.', attribution: '— 동료의 추모사', images: ['https://images.unsplash.com/photo-1529156069898-49953e39b3ac?w=1600'] },
          { id: 'final', chapter: 'CHAPTER VII', heading: '영원한 안식', quote: '이제 편히 쉬십시오. 당신이 뿌린 씨앗은 영원히 자라날 것입니다.', attribution: '', images: ['https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?w=1600'] },
          { id: 'ending', chapter: 'IN MEMORY', heading: '', quote: '', attribution: '', images: ['https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?w=1600'], type: 'ending' }
        ]
      };

      loadData(sample);
      alert('샘플 데이터를 불러왔습니다.');
    }

    // ===== BROADCAST =====
    function startBroadcast() {
      saveData();

      // Generate slides
      generateSlides();

      // Generate timeline
      generateTimeline();

      // Switch mode
      document.getElementById('setupMode').classList.add('hidden');
      document.getElementById('broadcastMode').classList.add('active');

      // Start
      state.currentSlide = 0;
      state.timer = 0;
      showSlide(0);
      startTimer();

      if (state.autoPlay) {
        startAutoPlay();
      }
    }

    function exitBroadcast() {
      stopAutoPlay();
      stopTimer();
      clearCarousels();

      document.getElementById('setupMode').classList.remove('hidden');
      document.getElementById('broadcastMode').classList.remove('active');
    }

    function generateSlides() {
      const container = document.getElementById('slidesContainer');
      container.innerHTML = '';

      state.sections.forEach((sec, idx) => {
        const kbEffect = KB_EFFECTS[idx % KB_EFFECTS.length];
        const slide = document.createElement('div');
        slide.className = `slide ${kbEffect}`;
        slide.id = `slide${idx}`;
        slide.style.setProperty('--kb-duration', `${state.duration}s`);

        if (sec.type === 'title') {
          slide.innerHTML = `
            <div class="slide-bg">
              ${sec.images.length > 1 ? generateCarousel(sec.images, idx) : `<img src="${sec.images[0]}" class="slide-bg-image" alt="">`}
            </div>
            <div class="slide-content">
              <h1 class="slide-title-main">${state.subject.name}</h1>
              <p class="slide-title-sub">${state.subject.title}</p>
              <p class="slide-years">${state.subject.birth} — ${state.subject.death}</p>
            </div>
          `;
        } else if (sec.type === 'ending') {
          slide.innerHTML = `
            <div class="slide-bg">
              ${sec.images.length > 1 ? generateCarousel(sec.images, idx) : `<img src="${sec.images[0]}" class="slide-bg-image" alt="">`}
            </div>
            <div class="slide-content ending-content">
              <div class="ending-line"></div>
              <p class="ending-text">In Loving Memory</p>
              <h2 class="ending-name">${state.subject.name}</h2>
              <p class="ending-years">${state.subject.birth} — ${state.subject.death}</p>
            </div>
          `;
        } else {
          slide.innerHTML = `
            <div class="slide-bg">
              ${sec.images.length > 1 ? generateCarousel(sec.images, idx) : `<img src="${sec.images[0] || 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22/%3E'}" class="slide-bg-image" alt="">`}
            </div>
            <div class="slide-content">
              <p class="slide-chapter">${sec.chapter}</p>
              <h2 class="slide-heading">${sec.heading || SECTION_TEMPLATES[idx].defaultHeading}</h2>
              ${sec.quote ? `<p class="slide-quote">${sec.quote}</p>` : ''}
              ${sec.attribution ? `<p class="slide-attribution">${sec.attribution}</p>` : ''}
            </div>
          `;
        }

        container.appendChild(slide);
      });
    }

    function generateCarousel(images, slideIdx) {
      return `
        <div class="slide-carousel" data-slide="${slideIdx}">
          ${images.map((img, i) => `<img src="${img}" class="carousel-image ${i === 0 ? 'active' : ''}" data-idx="${i}" alt="">`).join('')}
        </div>
      `;
    }

    function generateTimeline() {
      const timeline = document.getElementById('timeline');
      timeline.innerHTML = state.sections.map((_, idx) =>
        `<div class="timeline-dot ${idx === 0 ? 'active' : ''}" onclick="goToSlide(${idx})"></div>`
      ).join('');
    }

    function showSlide(idx) {
      document.querySelectorAll('.slide').forEach((s, i) => {
        s.classList.remove('active', 'exiting');
        if (i === idx) {
          s.classList.add('active');
        }
      });

      document.querySelectorAll('.timeline-dot').forEach((d, i) => {
        d.classList.toggle('active', i === idx);
      });

      // Start carousel if exists
      clearCarousels();
      const carousel = document.querySelector(`.slide-carousel[data-slide="${idx}"]`);
      if (carousel) {
        startCarousel(carousel);
      }

      updateProgress();
    }

    function startCarousel(carousel) {
      const images = carousel.querySelectorAll('.carousel-image');
      if (images.length <= 1) return;

      let current = 0;
      const interval = setInterval(() => {
        images[current].classList.remove('active');
        current = (current + 1) % images.length;
        images[current].classList.add('active');
      }, 5000);

      state.carouselIntervals.push(interval);
    }

    function clearCarousels() {
      state.carouselIntervals.forEach(i => clearInterval(i));
      state.carouselIntervals = [];
    }

    function nextSlide() {
      if (state.currentSlide < state.sections.length - 1) {
        state.currentSlide++;
        showSlide(state.currentSlide);
      } else {
        stopAutoPlay();
      }
    }

    function prevSlide() {
      if (state.currentSlide > 0) {
        state.currentSlide--;
        showSlide(state.currentSlide);
      }
    }

    function goToSlide(idx) {
      state.currentSlide = idx;
      showSlide(idx);
    }

    function updateProgress() {
      const progress = ((state.currentSlide + 1) / state.sections.length) * 100;
      document.getElementById('progressBar').style.width = `${progress}%`;
    }

    // ===== TIMER =====
    function startTimer() {
      state.timerInterval = setInterval(() => {
        state.timer++;
        updateTimerDisplay();
      }, 1000);
    }

    function stopTimer() {
      clearInterval(state.timerInterval);
    }

    function updateTimerDisplay() {
      const mins = Math.floor(state.timer / 60).toString().padStart(2, '0');
      const secs = (state.timer % 60).toString().padStart(2, '0');
      document.getElementById('timer').textContent = `${mins}:${secs}`;
    }

    // ===== AUTO PLAY =====
    let autoPlayInterval = null;

    function startAutoPlay() {
      state.isPlaying = true;
      document.getElementById('autoPlayLabel').textContent = 'PAUSE';
      autoPlayInterval = setInterval(() => {
        nextSlide();
      }, state.duration * 1000);
    }

    function stopAutoPlay() {
      state.isPlaying = false;
      document.getElementById('autoPlayLabel').textContent = 'AUTO';
      clearInterval(autoPlayInterval);
    }

    function toggleAutoPlay() {
      if (state.isPlaying) {
        stopAutoPlay();
      } else {
        startAutoPlay();
      }
    }

    // ===== KEYBOARD / TOUCH =====
    function handleKeyboard(e) {
      if (!document.getElementById('broadcastMode').classList.contains('active')) return;

      switch(e.key) {
        case 'ArrowRight':
        case ' ':
          nextSlide();
          break;
        case 'ArrowLeft':
          prevSlide();
          break;
        case 'Escape':
          exitBroadcast();
          break;
      }
    }

    // Touch swipe
    let touchStartX = 0;
    document.addEventListener('touchstart', e => {
      touchStartX = e.touches[0].clientX;
    });

    document.addEventListener('touchend', e => {
      if (!document.getElementById('broadcastMode').classList.contains('active')) return;

      const diff = touchStartX - e.changedTouches[0].clientX;
      if (Math.abs(diff) > 50) {
        if (diff > 0) nextSlide();
        else prevSlide();
      }
    });

    // Init
    init();
  </script>
</body>
</html>
